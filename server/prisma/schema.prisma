datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client-js"
}

enum SpellSource {
    SRD
    CUSTOM
}

enum FeatureKind {
    CLASS_FEATURE
    SUBCLASS_FEATURE
    TRAIT_FEATURE
    BACKGROUND_FEATURE
    FEAT_FEATURE
    CUSTOM_FEATURE
}

enum ProficiencyType {
    ARMOR
    WEAPON
    TOOL
    SKILL
    SAVING_THROW
    OTHER
}

model Spell {
    id                String      @id @default(cuid())
    source            SpellSource
    srdIndex          String?     @unique
    name              String
    description       String[]
    higherLevel       String[]    @default([])
    range             String?
    components        String[]    @default([])
    material          String?
    ritual            Boolean     @default(false)
    duration          String?
    concentration     Boolean     @default(false)
    castingTime       String
    level             Int
    damageAtSlotLevel Json?
    damageTypeIndex   String?
    attackType        String?
    schoolIndex       String
    classIndexes      String[]    @default([])
    subclassIndexes   String[]    @default([])
    sourceBook        String?
    raw               Json?
    spellLists        SpellListSpell[]
    characterSpells   CharacterSpell[]

    @@index([name])
    @@index([level])
    @@index([schoolIndex])
    @@index([ritual])
    @@index([concentration])
    @@index([classIndexes], type: Gin)
    @@index([subclassIndexes], type: Gin)
    @@index([sourceBook])
}

model AbilityScore {
    id             String         @id @default(cuid())
    source         SpellSource
    srdIndex       String?        @unique
    name           String
    fullName       String
    description    String[]
    skillIndexes   String[]
    abilityBonuses AbilityBonus[]
}

model Race {
    id                  String         @id @default(cuid())
    ownerUserId         String?
    srdIndex            String?        @unique
    name                String
    speed               Int?
    alignment           String?
    age                 String?
    size                String?
    sizeDescription     String?
    languageDescription String?
    languageIndexes     String[]       @default([])
    traitIndexes        String[]       @default([])
    subraceIndexes      String[]       @default([])
    sourceBook          String?
    raw                 Json?
    abilityBonuses      AbilityBonus[]
    traits              Trait[]        @relation("RaceTraits")
    subraces            Subrace[]
    languages           Language[]     @relation("RaceLanguages")
    features            Feature[]      @relation("RaceFeatures")
    characters          Character[]    @relation("CharacterRaceRelation")

    @@index([ownerUserId])
    @@index([name])
}

// Join table between race and ability score, storing the bonus to that score
// that the race receieves
model AbilityBonus {
    race           Race         @relation(fields: [raceId], references: [id])
    raceId         String
    abilityScore   AbilityScore @relation(fields: [abilityScoreId], references: [id])
    abilityScoreId String
    bonus          Int

    @@id([raceId, abilityScoreId])
}

model Class {
    id              String         @id @default(cuid())
    ownerUserId     String?
    srdIndex        String?        @unique
    name            String
    hitDie          Int?
    spellcastingAbility String?
    sourceBook      String?
    raw             Json?
    subclasses      Subclass[]
    proficiencies   Proficiency[]  @relation("ClassProficiencies")
    features        Feature[]      @relation("ClassFeatures")
    characters      Character[]    @relation("CharacterClassRelation")

    @@index([ownerUserId])
    @@index([name])
}

model Subclass {
    id              String      @id @default(cuid())
    ownerUserId     String?
    srdIndex        String?     @unique
    name            String
    classId         String
    classRef        Class       @relation(fields: [classId], references: [id], onDelete: Cascade)
    sourceBook      String?
    raw             Json?
    features        Feature[]   @relation("SubclassFeatures")
    characters      Character[] @relation("CharacterSubclassRelation")

    @@index([ownerUserId])
    @@index([classId])
    @@index([name])
}

model Background {
    id                  String         @id @default(cuid())
    ownerUserId         String?
    srdIndex            String?        @unique
    name                String
    featureName         String?
    featureDescription  String[]       @default([])
    languageChoiceCount Int?
    sourceBook          String?
    raw                 Json?
    proficiencies       Proficiency[]  @relation("BackgroundProficiencies")
    languages           Language[]     @relation("BackgroundLanguages")
    features            Feature[]      @relation("BackgroundFeatures")
    characters          Character[]    @relation("CharacterBackgroundRelation")

    @@index([ownerUserId])
    @@index([name])
}

model Trait {
    id                  String         @id @default(cuid())
    ownerUserId         String?
    srdIndex            String?        @unique
    name                String
    description         String[]       @default([])
    languageChoiceCount Int?
    sourceBook          String?
    raw                 Json?
    races               Race[]         @relation("RaceTraits")
    subraces            Subrace[]      @relation("SubraceTraits")
    proficiencies       Proficiency[]  @relation("TraitProficiencies")
    languages           Language[]     @relation("TraitLanguages")
    features            Feature[]      @relation("TraitFeatures")

    @@index([ownerUserId])
    @@index([name])
}

model Subrace {
    id              String      @id @default(cuid())
    ownerUserId     String?
    srdIndex        String?     @unique
    name            String
    description     String?
    raceId          String
    raceRef         Race        @relation(fields: [raceId], references: [id], onDelete: Cascade)
    sourceBook      String?
    raw             Json?
    traits          Trait[]     @relation("SubraceTraits")
    features        Feature[]   @relation("SubraceFeatures")
    characters      Character[] @relation("CharacterSubraceRelation")

    @@index([ownerUserId])
    @@index([raceId])
    @@index([name])
}

model Feat {
    id              String          @id @default(cuid())
    ownerUserId     String?
    srdIndex        String?         @unique
    name            String
    description     String[]        @default([])
    sourceBook      String?
    raw             Json?
    features        Feature[]       @relation("FeatFeatures")
    characterFeats  CharacterFeat[]

    @@index([ownerUserId])
    @@index([name])
}

model Language {
    id                  String              @id @default(cuid())
    ownerUserId         String?
    srdIndex            String?             @unique
    name                String
    type                String?
    script              String?
    description         String?
    sourceBook          String?
    raw                 Json?
    races               Race[]              @relation("RaceLanguages")
    backgrounds         Background[]        @relation("BackgroundLanguages")
    traits              Trait[]             @relation("TraitLanguages")
    characterLanguages  CharacterLanguage[]

    @@index([ownerUserId])
    @@index([name])
}

model Proficiency {
    id                      String                  @id @default(cuid())
    ownerUserId             String?
    srdIndex                String?                 @unique
    name                    String
    type                    ProficiencyType
    sourceBook              String?
    raw                     Json?
    classes                 Class[]                 @relation("ClassProficiencies")
    backgrounds             Background[]            @relation("BackgroundProficiencies")
    traits                  Trait[]                 @relation("TraitProficiencies")
    characterProficiencies  CharacterProficiency[]

    @@index([ownerUserId])
    @@index([name])
    @@index([type])
}

model Feature {
    id              String           @id @default(cuid())
    ownerUserId     String?
    srdIndex        String?          @unique
    name            String
    description     String[]         @default([])
    level           Int?
    kind            FeatureKind
    sourceLabel     String?
    sourceBook      String?
    raw             Json?
    classId         String?
    subclassId      String?
    raceId          String?
    subraceId       String?
    backgroundId    String?
    traitId         String?
    featId          String?
    classRef        Class?           @relation("ClassFeatures", fields: [classId], references: [id], onDelete: SetNull)
    subclassRef     Subclass?        @relation("SubclassFeatures", fields: [subclassId], references: [id], onDelete: SetNull)
    raceRef         Race?            @relation("RaceFeatures", fields: [raceId], references: [id], onDelete: SetNull)
    subraceRef      Subrace?         @relation("SubraceFeatures", fields: [subraceId], references: [id], onDelete: SetNull)
    backgroundRef   Background?      @relation("BackgroundFeatures", fields: [backgroundId], references: [id], onDelete: SetNull)
    traitRef        Trait?           @relation("TraitFeatures", fields: [traitId], references: [id], onDelete: SetNull)
    featRef         Feat?            @relation("FeatFeatures", fields: [featId], references: [id], onDelete: SetNull)
    characterFeatures CharacterFeature[]

    @@index([ownerUserId])
    @@index([name])
    @@index([kind])
    @@index([classId])
    @@index([subclassId])
    @@index([raceId])
    @@index([subraceId])
    @@index([backgroundId])
    @@index([traitId])
    @@index([featId])
}

model SpellList {
    id          String           @id @default(cuid())
    name        String
    ownerUserId String
    createdAt   DateTime         @default(now())
    spells      SpellListSpell[]

    @@index([ownerUserId])
}

model SpellListSpell {
    spellList   SpellList @relation(fields: [spellListId], references: [id], onDelete: Cascade)
    spellListId String
    spell       Spell     @relation(fields: [spellId], references: [id], onDelete: Cascade)
    spellId     String
    addedAt     DateTime  @default(now())

    @@id([spellListId, spellId])
}

// ---------------------------------------------------------------------------
// Character Sheet
// ---------------------------------------------------------------------------

model Character {
    id                  String    @id @default(cuid())
    ownerUserId         String
    createdAt           DateTime  @default(now())

    // Identity
    name                String
    race                String
    class               String
    subclass            String?
    level               Int
    alignment           String
    background          String
    classId             String?
    subclassId          String?
    raceId              String?
    subraceId           String?
    backgroundId        String?

    // Quick / combat scalars
    proficiencyBonus    Int
    inspiration         Boolean   @default(false)
    ac                  Int
    speed               Int
    initiative          Int
    spellcastingAbility String?
    spellSaveDC         Int?
    spellAttackBonus    Int?
    conditions          String[]  @default([])
    notes               String    @default("")

    // Relations
    classRef            Class?               @relation("CharacterClassRelation", fields: [classId], references: [id], onDelete: SetNull)
    subclassRef         Subclass?            @relation("CharacterSubclassRelation", fields: [subclassId], references: [id], onDelete: SetNull)
    raceRef             Race?                @relation("CharacterRaceRelation", fields: [raceId], references: [id], onDelete: SetNull)
    subraceRef          Subrace?             @relation("CharacterSubraceRelation", fields: [subraceId], references: [id], onDelete: SetNull)
    backgroundRef       Background?          @relation("CharacterBackgroundRelation", fields: [backgroundId], references: [id], onDelete: SetNull)
    stats               CharacterStats?
    attacks             Attack[]
    inventory           InventoryItem[]
    features            CharacterFeature[]
    feats               CharacterFeat[]
    languages           CharacterLanguage[]
    proficiencies       CharacterProficiency[]
    spellSlots          SpellSlot[]
    spellbook           CharacterSpell[]

    @@index([ownerUserId])
    @@index([classId])
    @@index([subclassId])
    @@index([raceId])
    @@index([subraceId])
    @@index([backgroundId])
}

// 1:1 table for interactive stat blocks (each updated independently)
model CharacterStats {
    id                        String   @id @default(cuid())
    character                 Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId               String   @unique

    abilityScores             Json     // { strength, dexterity, constitution, intelligence, wisdom, charisma }
    hp                        Json     // { current, max, temp }
    deathSaves                Json     // { successes, failures }
    hitDice                   Json     // { total, remaining, die }
    savingThrowProficiencies  String[] @default([])
    skillProficiencies        Json     // Record<SkillName, 'none' | 'proficient' | 'expert'>
    traits                    Json     // { personality, ideals, bonds, flaws }
    currency                  Json     // { cp, sp, ep, gp, pp }
}

model Attack {
    id            String    @id @default(cuid())
    character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId   String
    name          String
    attackBonus   String    // e.g. "+7"
    damage        String    // e.g. "1d4+3 P"
    type          String    // 'melee' | 'ranged' | 'spell'

    @@index([characterId])
}

model InventoryItem {
    id            String    @id @default(cuid())
    character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId   String
    name          String
    quantity      Int       @default(1)
    weight        Float?
    description   String?
    equipped      Boolean   @default(false)
    magical       Boolean   @default(false)

    @@index([characterId])
}

model CharacterFeature {
    id              String    @id @default(cuid())
    character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId     String
    feature         Feature?  @relation(fields: [featureId], references: [id], onDelete: SetNull)
    featureId       String?
    name            String
    source          String    // e.g. "Wizard 2", "High Elf"
    description     String
    usesMax         Int?
    usesRemaining   Int?
    recharge        String?   // 'short' | 'long' | 'dawn'

    @@index([characterId])
    @@index([featureId])
}

model CharacterFeat {
    character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId     String
    feat            Feat      @relation(fields: [featId], references: [id], onDelete: Cascade)
    featId          String

    @@id([characterId, featId])
}

model CharacterLanguage {
    character       Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId     String
    language        Language  @relation(fields: [languageId], references: [id], onDelete: Cascade)
    languageId      String

    @@id([characterId, languageId])
}

model CharacterProficiency {
    character       Character   @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId     String
    proficiency     Proficiency @relation(fields: [proficiencyId], references: [id], onDelete: Cascade)
    proficiencyId   String

    @@id([characterId, proficiencyId])
}

model SpellSlot {
    id            String    @id @default(cuid())
    character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId   String
    level         Int       // 1â€“9
    total         Int
    used          Int       @default(0)

    @@unique([characterId, level])
    @@index([characterId])
}

model CharacterSpell {
    character     Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
    characterId   String
    spell         Spell     @relation(fields: [spellId], references: [id], onDelete: Cascade)
    spellId       String
    prepared      Boolean   @default(false)

    @@id([characterId, spellId])
    @@map("CharacterPreparedSpell")
}
